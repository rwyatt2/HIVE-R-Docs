"use strict";(globalThis.webpackChunktemp_docs=globalThis.webpackChunktemp_docs||[]).push([[4391],{8620(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>a,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"production-readiness/phase-5-observability","title":"Phase 5: Observability Stack","description":"\u23f1\ufe0f Time: 10-12 hours","source":"@site/docs/production-readiness/06-phase-5-observability.md","sourceDirName":"production-readiness","slug":"/production-readiness/phase-5-observability","permalink":"/HIVE-R-Docs/docs/production-readiness/phase-5-observability","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/production-readiness/06-phase-5-observability.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Phase 5: Observability Stack","sidebar_label":"Phase 5: Observability Stack"},"sidebar":"tutorialSidebar","previous":{"title":"Phase 4: Reliability & Fallbacks","permalink":"/HIVE-R-Docs/docs/production-readiness/phase-4-reliability"},"next":{"title":"Phase 6: Performance Optimization","permalink":"/HIVE-R-Docs/docs/production-readiness/phase-6-performance"}}');var i=s(4848),t=s(8453);const l={title:"Phase 5: Observability Stack",sidebar_label:"Phase 5: Observability Stack"},c="Start server, make request",o={},d=[];function h(e){const n={a:"a",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"**"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u23f1\ufe0f Time"}),": 10-12 hours"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcb0 Budget"}),": $20-25"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83c\udfaf Goal"}),": Deep visibility into system behavior"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83e\udd16 AI Workers"}),": HIVE-R SRE + Data Analyst + Builder agents"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud83d\udcca Step 5.1: Implement Structured Logging"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,i.jsx)(n.p,{children:"Consult the SRE and Builder agents."}),"\n",(0,i.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,i.jsx)(n.p,{children:"We're using console.log() scattered everywhere. This is unmaintainable in production."}),"\n",(0,i.jsx)(n.p,{children:"TASK:"}),"\n",(0,i.jsx)(n.p,{children:"Migrate to structured JSON logging with Pino:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 1. Replace all console.log/error/warn with logger"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 2. Add context to every log (requestId, userId, agentName)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 3. Configure log levels by environment (debug in dev, info in prod)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 4. Add log rotation (don't fill disk)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 5. Format for log aggregation tools (ELK, Datadog)"}),"\n",(0,i.jsx)(n.p,{children:"LOG STRUCTURE:"}),"\n",(0,i.jsx)(n.p,{children:"{"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "level": "info",'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "time": "2026-02-07T12:34:56.789Z",'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "requestId": "req-123",'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "userId": "user-456",'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "agentName": "builder",'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "msg": "Agent invocation started",'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "duration": 1234,'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "tokens": 500,'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 "cost": 0.015'}),"\n",(0,i.jsx)(n.p,{children:"}"}),"\n",(0,i.jsx)(n.p,{children:"IMPLEMENTATION:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Install: pino, pino-pretty (dev), pino-rotating-file-stream"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create logger singleton: src/lib/logger.ts"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add middleware to inject requestId"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Update ALL files that use console.log"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Logger configuration"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Migration of all console.log calls"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Log rotation setup (daily, keep 7 days)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Environment-based log levels"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Documentation: docs/operations/logging.md"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"Review the logger configuration:"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Uses JSON in production (for parsing)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Uses pretty-print in development (for readability)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 RequestId propagates through all logs in a request"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Sensitive data not logged (API keys, passwords)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Test"}),":"]}),"\n",(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"start-server-make-request",children:"Start server, make request"})}),"\n",(0,i.jsx)(n.p,{children:"npm run dev"}),"\n",(0,i.jsxs)(n.p,{children:["curl ",(0,i.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"test"}]}\'']}),"\n",(0,i.jsx)(n.h1,{id:"check-logs-should-be-json-in-one-line",children:"Check logs (should be JSON in one line)"}),"\n",(0,i.jsx)(n.p,{children:"tail -f logs/hive.log | jq"}),"\n",(0,i.jsx)(n.h1,{id:"should-see-structured-logs-with-all-context-fields",children:"Should see structured logs with all context fields"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u2610 All console.logs replaced"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Logs are structured JSON"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 RequestId tracks through multi-agent flow"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Log rotation working (check after 24h)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 No sensitive data in logs"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.20 (60K tokens - lots of file changes)"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud83d\udcc8 Step 5.2: Add Prometheus Metrics"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,i.jsx)(n.p,{children:"Consult the SRE agent."}),"\n",(0,i.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,i.jsx)(n.p,{children:"Logs tell us what happened. Metrics tell us trends over time."}),"\n",(0,i.jsx)(n.p,{children:"TASK:"}),"\n",(0,i.jsx)(n.p,{children:"Implement Prometheus metrics for:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Request rate (requests/sec by endpoint)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Response latency (histogram: p50, p95, p99)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Error rate (% of requests that failed)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Agent invocations (counter by agent name)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Token usage (counter by model)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Cost (gauge: current spend rate)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Circuit breaker state (gauge: 0=closed, 1=open)"}),"\n",(0,i.jsx)(n.p,{children:"IMPLEMENTATION:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Install: prom-client"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create metrics registry: src/lib/metrics.ts"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add middleware to track HTTP metrics"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Expose /metrics endpoint (for Prometheus scraper)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Custom metrics for agent-specific tracking"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"METRIC NAMING:"}),"\n",(0,i.jsx)(n.p,{children:"Follow Prometheus conventions:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"hive_http_requests_total (counter)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"hive_http_request_duration_seconds (histogram)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"hive_agent_invocations_total (counter)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"hive_token_usage_total (counter)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"hive_cost_dollars (gauge)"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Metrics registry and instrumentation"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"/metrics endpoint"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Grafana dashboard JSON (for import)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Documentation on adding custom metrics"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"Review the metrics design:"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Covers the key system behaviors"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Has labels for filtering (agent, model, status_code)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Histogram buckets appropriate (0.1s, 0.5s, 1s, 5s, 10s)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 /metrics endpoint doesn't require auth (Prometheus needs it)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Test"}),":"]}),"\n",(0,i.jsx)(n.h1,{id:"start-server",children:"Start server"}),"\n",(0,i.jsx)(n.p,{children:"npm run dev"}),"\n",(0,i.jsx)(n.h1,{id:"make-some-requests",children:"Make some requests"}),"\n",(0,i.jsx)(n.p,{children:"for i in {1..10}; do"}),"\n",(0,i.jsxs)(n.p,{children:["\xa0 curl ",(0,i.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"test"}]}\'']}),"\n",(0,i.jsx)(n.p,{children:"done"}),"\n",(0,i.jsx)(n.h1,{id:"check-metrics-endpoint",children:"Check metrics endpoint"}),"\n",(0,i.jsxs)(n.p,{children:["curl ",(0,i.jsx)(n.a,{href:"http://localhost:3000/metrics",children:"http://localhost:3000/metrics"})]}),"\n",(0,i.jsx)(n.h1,{id:"should-see-prometheus-format",children:"Should see Prometheus format:"}),"\n",(0,i.jsx)(n.h1,{id:"hive_http_requests_totalmethodpostpathchatstatus200-10",children:'hive_http_requests_total{method="POST",path="/chat",status="200"} 10'}),"\n",(0,i.jsx)(n.h1,{id:"hive_agent_invocations_totalagentrouter-10",children:'hive_agent_invocations_total{agent="router"} 10'}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u2610 /metrics endpoint returns valid Prometheus format"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Metrics update in real-time"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Includes both system and custom metrics"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 No performance impact (<5ms per request)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.12 (35K tokens)"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud83d\udcc9 Step 5.3: Set Up Grafana Dashboard"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,i.jsx)(n.p,{children:"Consult the Data Analyst and SRE agents."}),"\n",(0,i.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,i.jsx)(n.p,{children:"We have metrics. Now we need visualization."}),"\n",(0,i.jsx)(n.p,{children:"TASK:"}),"\n",(0,i.jsx)(n.p,{children:"Data Analyst: Design dashboard layout with panels for:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Request rate (line chart, last 1h)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Response latency (heatmap, p50/p95/p99)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Error rate (gauge, % of requests)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Agent usage (bar chart, invocations per agent)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Token usage (stacked area, by model over time)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Cost burn rate (line chart, $/hour)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Circuit breaker status (status indicator)"}),"\n",(0,i.jsx)(n.p,{children:"SRE: Create Grafana dashboard JSON:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Use Prometheus as data source"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Auto-refresh every 30s"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Time range selector (1h, 6h, 24h, 7d)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Variables for filtering (agent, model)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Alert rules (error rate >5%, cost >$10/hour)"}),"\n",(0,i.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Grafana dashboard JSON: grafana/dashboards/hive-overview.json"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Docker compose with Grafana + Prometheus"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Setup instructions: docs/operations/monitoring-setup.md"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Screenshot of dashboard for README"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"Review the dashboard design (Data Analyst will provide mockup):"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Most important metrics above the fold"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Color coding (green=good, yellow=warning, red=critical)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Time range covers operational needs (1h for incidents, 7d for trends)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Setup Grafana"}),":"]}),"\n",(0,i.jsx)(n.h1,{id:"add-to-docker-composeyml",children:"Add to docker-compose.yml"}),"\n",(0,i.jsx)(n.p,{children:"cat >> docker-compose.yml << 'EOF'"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 prometheus:"}),"\n",(0,i.jsxs)(n.p,{children:["\xa0 \xa0 image: prom/prometheus",":latest"]}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 volumes:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - ./prometheus.yml:/etc/prometheus/prometheus.yml"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - prometheus-data:/prometheus"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 ports:"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "9090:9090"'}),"\n",(0,i.jsx)(n.p,{children:"\xa0 grafana:"}),"\n",(0,i.jsxs)(n.p,{children:["\xa0 \xa0 image: grafana/grafana",":latest"]}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 volumes:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - ./grafana/dashboards:/etc/grafana/provisioning/dashboards"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - ./grafana/datasources:/etc/grafana/provisioning/datasources"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - grafana-data:/var/lib/grafana"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 ports:"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "3001:3000"'}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 environment:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - GF_SECURITY_ADMIN_PASSWORD=admin"}),"\n",(0,i.jsx)(n.p,{children:"EOF"}),"\n",(0,i.jsx)(n.h1,{id:"create-prometheus-config",children:"Create Prometheus config"}),"\n",(0,i.jsx)(n.p,{children:"cat > prometheus.yml << 'EOF'"}),"\n",(0,i.jsx)(n.p,{children:"global:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 scrape_interval: 15s"}),"\n",(0,i.jsx)(n.p,{children:"scrape_configs:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - job_name: 'hive'"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 static_configs:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - targets: ['host.docker.internal:3000']"}),"\n",(0,i.jsx)(n.p,{children:"EOF"}),"\n",(0,i.jsx)(n.h1,{id:"start-monitoring-stack",children:"Start monitoring stack"}),"\n",(0,i.jsx)(n.p,{children:"docker-compose up -d prometheus grafana"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Access Grafana"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open ",(0,i.jsx)(n.a,{href:"http://localhost:3001",children:"http://localhost:3001"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Login (admin/admin)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add Prometheus data source (",(0,i.jsx)(n.a,{href:"http://prometheus:9090",children:"http://prometheus:9090"}),")"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Import dashboard JSON"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Grafana loads dashboard"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 All panels show data"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Metrics update in real-time"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Alerts configured"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.10 (30K tokens)"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud83d\udd0d Step 5.4: Implement Distributed Tracing"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,i.jsx)(n.p,{children:"Consult the SRE agent."}),"\n",(0,i.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,i.jsx)(n.p,{children:"When a request flows through 5+ agents, we need to trace it end-to-end."}),"\n",(0,i.jsx)(n.p,{children:"TASK:"}),"\n",(0,i.jsx)(n.p,{children:"Implement OpenTelemetry distributed tracing:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Trace a request from entry (/chat) through all agent invocations"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Each agent span shows: name, duration, model used, tokens, cost"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Parent-child relationships visible (Router \u2192 Builder \u2192 Reviewer)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Export traces to Jaeger (visualization)"}),"\n",(0,i.jsx)(n.p,{children:"IMPLEMENTATION:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Install: @opentelemetry/api, @opentelemetry/sdk-node, @opentelemetry/exporter-jaeger"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Initialize tracer: src/lib/tracer.ts"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Instrument HTTP server (auto)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Manually instrument agent invocations"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Propagate trace context through LangGraph state"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"SPAN ATTRIBUTES:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"agent.name"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"agent.model"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"agent.tokens_in"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"agent.tokens_out"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"agent.cost"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"agent.duration_ms"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Tracer initialization"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Agent instrumentation"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Jaeger setup in docker-compose"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Documentation: docs/operations/tracing.md"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"Review the tracing approach:"}),"\n",(0,i.jsx)(n.p,{children:'\u2610 Spans have meaningful names (not "function1", "function2")'}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Trace context propagates through async agent calls"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Doesn't add >10ms latency per request"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Sampling configured (don't trace 100% in prod, maybe 10%)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Setup Jaeger"}),":"]}),"\n",(0,i.jsx)(n.h1,{id:"add-to-docker-composeyml-1",children:"Add to docker-compose.yml"}),"\n",(0,i.jsx)(n.p,{children:"cat >> docker-compose.yml << 'EOF'"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 jaeger:"}),"\n",(0,i.jsxs)(n.p,{children:["\xa0 \xa0 image: jaegertracing/all-in-one",":latest"]}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 ports:"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "16686:16686"\xa0 # UI'}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "14268:14268"\xa0 # Collector'}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 environment:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - COLLECTOR_ZIPKIN_HTTP_PORT=9411"}),"\n",(0,i.jsx)(n.p,{children:"EOF"}),"\n",(0,i.jsx)(n.p,{children:"docker-compose up -d jaeger"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Test"}),":"]}),"\n",(0,i.jsx)(n.h1,{id:"make-a-request",children:"Make a request"}),"\n",(0,i.jsxs)(n.p,{children:["curl ",(0,i.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"build a button"}]}\'']}),"\n",(0,i.jsx)(n.h1,{id:"open-jaeger-ui",children:"Open Jaeger UI"}),"\n",(0,i.jsxs)(n.p,{children:["open ",(0,i.jsx)(n.a,{href:"http://localhost:16686",children:"http://localhost:16686"})]}),"\n",(0,i.jsx)(n.h1,{id:"search-for-traces-select-one",children:"Search for traces, select one"}),"\n",(0,i.jsx)(n.h1,{id:"should-see-waterfall-router--builder--other-agents",children:"Should see waterfall: Router \u2192 Builder \u2192 (other agents)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Traces appear in Jaeger"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Spans show parent-child relationships"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Agent names and durations visible"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Can trace a request through 5+ agents"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.15 (45K tokens)"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\ud83d\udea8 Step 5.5: Configure Alerting"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,i.jsx)(n.p,{children:"Consult the SRE agent."}),"\n",(0,i.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,i.jsx)(n.p,{children:"Metrics and dashboards are reactive. We need proactive alerts."}),"\n",(0,i.jsx)(n.p,{children:"TASK:"}),"\n",(0,i.jsx)(n.p,{children:"Configure Prometheus alerting rules for:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - High error rate: >5% of requests failing (5min average)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - High latency: p95 >5 seconds (5min average)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Agent failures: Any agent failing >50% of time"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Cost spike: $/hour >$20 (when monthly budget is $1500)"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Circuit breaker open: Any circuit open >5 minutes"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - Low disk space: <10GB remaining"}),"\n",(0,i.jsx)(n.p,{children:"ALERT ROUTING:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Critical: Page on-call (PagerDuty/Opsgenie)"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Warning: Slack notification"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Info: Log only"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"IMPLEMENTATION:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Prometheus alert rules: prometheus/alerts.yml"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Alertmanager config: prometheus/alertmanager.yml"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Slack webhook integration"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Test alerts with mock failures"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Alert rules file"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Alertmanager configuration"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Docker compose with Alertmanager"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Runbook links in alerts (so responder knows what to do)"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"Review alert thresholds:"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Not too sensitive (won't page for every hiccup)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Not too lenient (catches real issues)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Has runbook links (alerts are actionable)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Grouped to prevent alert storm (max 1 alert per 5min)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Setup Alertmanager"}),":"]}),"\n",(0,i.jsx)(n.h1,{id:"create-alert-rules",children:"Create alert rules"}),"\n",(0,i.jsx)(n.p,{children:"cat > prometheus/alerts.yml << 'EOF'"}),"\n",(0,i.jsx)(n.p,{children:"groups:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 - name: hive_alerts"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 interval: 30s"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 rules:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - alert: HighErrorRate"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 \xa0 expr: rate(hive_http_requests_total{status=~"5.."}[5m]) > 0.05'}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 for: 5m"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 labels:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 \xa0 severity: critical"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 annotations:"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 \xa0 \xa0 summary: "High error rate: {{ $value }}%"'}),"\n",(0,i.jsxs)(n.p,{children:['\xa0 \xa0 \xa0 \xa0 \xa0 runbook: "',(0,i.jsx)(n.a,{href:"https://github.com/you/hive-r/docs/runbook.md#high-error-rate",children:"https://github.com/you/hive-r/docs/runbook.md#high-error-rate"}),'"']}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - alert: HighCostBurn"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 expr: rate(hive_cost_dollars[1h]) * 3600 > 20"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 for: 10m"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 labels:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 \xa0 severity: warning"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 \xa0 annotations:"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 \xa0 \xa0 summary: "Cost burn rate: ${{ $value }}/hour"'}),"\n",(0,i.jsx)(n.p,{children:"EOF"}),"\n",(0,i.jsx)(n.h1,{id:"add-alertmanager-to-docker-composeyml",children:"Add Alertmanager to docker-compose.yml"}),"\n",(0,i.jsx)(n.p,{children:"cat >> docker-compose.yml << 'EOF'"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 alertmanager:"}),"\n",(0,i.jsxs)(n.p,{children:["\xa0 \xa0 image: prom/alertmanager",":latest"]}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 volumes:"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - ./prometheus/alertmanager.yml:/etc/alertmanager/alertmanager.yml"}),"\n",(0,i.jsx)(n.p,{children:"\xa0 \xa0 ports:"}),"\n",(0,i.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "9093:9093"'}),"\n",(0,i.jsx)(n.p,{children:"EOF"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Test alerts"}),":"]}),"\n",(0,i.jsx)(n.h1,{id:"trigger-high-error-rate-stop-database-to-cause-errors",children:"Trigger high error rate (stop database to cause errors)"}),"\n",(0,i.jsx)(n.p,{children:"docker stop hive-postgres"}),"\n",(0,i.jsx)(n.h1,{id:"make-requests-should-fail",children:"Make requests (should fail)"}),"\n",(0,i.jsxs)(n.p,{children:["for i in {1..20}; do curl ",(0,i.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),"; done"]}),"\n",(0,i.jsx)(n.h1,{id:"wait-5-minutes",children:"Wait 5 minutes"}),"\n",(0,i.jsxs)(n.h1,{id:"check-alertmanager-httplocalhost9093",children:["Check Alertmanager: ",(0,i.jsx)(n.a,{href:"http://localhost:9093",children:"http://localhost:9093"})]}),"\n",(0,i.jsx)(n.h1,{id:"should-see-higherrorrate-alert-firing",children:'Should see "HighErrorRate" alert firing'}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Alerts fire correctly"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Slack notifications work"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Alerts resolve when issue fixed"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 No alert spam (grouped properly)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.08 (25K tokens)"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u2705 Phase 5 Complete When:"})}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Structured logging active (all console.logs replaced)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Prometheus metrics exposed"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Grafana dashboard showing real data"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Distributed tracing working (Jaeger shows spans)"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Alerting configured and tested"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Monitoring stack runs in Docker"}),"\n",(0,i.jsx)(n.p,{children:"\u2610 Total cost <$25 for Phase 5"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udca1 Key Insight"}),": You can now debug production issues 10x faster with full observability."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud83d\udcf8 Take Screenshot"}),": Of Grafana dashboard + Jaeger trace for your portfolio/docs."]}),"\n",(0,i.jsx)(n.p,{children:"**"})]})}function a(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453(e,n,s){s.d(n,{R:()=>l,x:()=>c});var r=s(6540);const i={},t=r.createContext(i);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);