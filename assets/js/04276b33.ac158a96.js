"use strict";(globalThis.webpackChunktemp_docs=globalThis.webpackChunktemp_docs||[]).push([[1824],{9747(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>a,frontMatter:()=>t,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"production-readiness/phase-6-performance","title":"Phase 6: Performance Optimization","description":"\u23f1\ufe0f Time: 10-12 hours","source":"@site/docs/production-readiness/07-phase-6-performance.md","sourceDirName":"production-readiness","slug":"/production-readiness/phase-6-performance","permalink":"/HIVE-R-Docs/docs/production-readiness/phase-6-performance","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/production-readiness/07-phase-6-performance.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"title":"Phase 6: Performance Optimization","sidebar_label":"Phase 6: Performance Optimization"},"sidebar":"tutorialSidebar","previous":{"title":"Phase 5: Observability Stack","permalink":"/HIVE-R-Docs/docs/production-readiness/phase-5-observability"},"next":{"title":"Phase 7: CI/CD & Automation","permalink":"/HIVE-R-Docs/docs/production-readiness/phase-7-cicd"}}');var r=s(4848),l=s(8453);const t={title:"Phase 6: Performance Optimization",sidebar_label:"Phase 6: Performance Optimization"},c="Add to docker-compose.yml",d={},h=[];function o(e){const n={a:"a",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"**"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u23f1\ufe0f Time"}),": 10-12 hours"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcb0 Budget"}),": $25-30"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83c\udfaf Goal"}),": 50% cost reduction, 80% latency reduction (for cached requests)"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83e\udd16 AI Workers"}),": HIVE-R Data Analyst + Builder + Planner agents"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u26a1 Step 6.1: Implement Response Caching"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,r.jsx)(n.p,{children:"Consult the Planner and Builder agents."}),"\n",(0,r.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,r.jsx)(n.p,{children:"Many user requests are similar or identical. We're calling expensive LLMs unnecessarily."}),"\n",(0,r.jsx)(n.p,{children:"TASK:"}),"\n",(0,r.jsx)(n.p,{children:"Planner: Design caching strategy"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - What to cache? (completed agent responses)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Cache key? (hash of messages + agent + model)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - TTL? (1 hour for code generation, 24h for planning)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Invalidation? (user can force refresh, or version changes)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Storage? (Redis for shared cache, or in-memory for dev)"}),"\n",(0,r.jsx)(n.p,{children:"Builder: Implement semantic caching"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Use embeddings to find similar queries (cosine similarity >0.95)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Store: embedding vector, original query, response, metadata"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Check cache before every agent invocation"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Metrics: cache_hit_rate, cache_latency"}),"\n",(0,r.jsx)(n.p,{children:"SEMANTIC SEARCH:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Generate embedding for new query (OpenAI text-embedding-ada-002)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Vector search in Redis (with RedisSearch) or Qdrant"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"If similarity >0.95, return cached response"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"If miss, invoke agent and cache result"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Cache strategy doc: docs/architecture/caching.md"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Redis setup in docker-compose"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Semantic cache implementation: src/lib/semantic-cache.ts"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Integration in agent middleware"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Cache management endpoints: /api/admin/cache/clear"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"Review the caching strategy:"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Similarity threshold (0.95) is reasonable (not too loose)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 TTLs make sense (short for dynamic, long for static)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Cache doesn't store sensitive data (user IDs anonymized)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Has manual override (users can bypass cache with flag)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Setup Redis"}),":"]}),"\n",(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"add-to-docker-composeyml",children:"Add to docker-compose.yml"})}),"\n",(0,r.jsx)(n.p,{children:"cat >> docker-compose.yml << 'EOF'"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 redis:"}),"\n",(0,r.jsxs)(n.p,{children:["\xa0 \xa0 image: redis/redis-stack",":latest","\xa0 # Includes RedisSearch"]}),"\n",(0,r.jsx)(n.p,{children:"\xa0 \xa0 ports:"}),"\n",(0,r.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "6379:6379"'}),"\n",(0,r.jsx)(n.p,{children:'\xa0 \xa0 \xa0 - "8001:8001"\xa0 # RedisInsight UI'}),"\n",(0,r.jsx)(n.p,{children:"\xa0 \xa0 volumes:"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 \xa0 \xa0 - redis-data:/data"}),"\n",(0,r.jsx)(n.p,{children:"EOF"}),"\n",(0,r.jsx)(n.p,{children:"docker-compose up -d redis"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Test caching"}),":"]}),"\n",(0,r.jsx)(n.h1,{id:"first-request-cache-miss",children:"First request (cache miss)"}),"\n",(0,r.jsxs)(n.p,{children:["time curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"build a login form"}]}\'']}),"\n",(0,r.jsx)(n.h1,{id:"should-take-3-5-seconds",children:"Should take 3-5 seconds"}),"\n",(0,r.jsx)(n.h1,{id:"second-identical-request-cache-hit",children:"Second identical request (cache hit)"}),"\n",(0,r.jsxs)(n.p,{children:["time curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"build a login form"}]}\'']}),"\n",(0,r.jsx)(n.h1,{id:"should-take-100ms",children:"Should take <100ms"}),"\n",(0,r.jsx)(n.h1,{id:"similar-request-semantic-hit",children:"Similar request (semantic hit)"}),"\n",(0,r.jsxs)(n.p,{children:["time curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"create a login page"}]}\'']}),"\n",(0,r.jsx)(n.h1,{id:"should-also-be-fast-similar-query",children:"Should also be fast (similar query)"}),"\n",(0,r.jsx)(n.h1,{id:"check-metrics",children:"Check metrics"}),"\n",(0,r.jsxs)(n.p,{children:["curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/metrics",children:"http://localhost:3000/metrics"})," | grep cache_hit_rate"]}),"\n",(0,r.jsx)(n.h1,{id:"should-show-05-50-hit-rate-after-a-few-requests",children:"Should show >0.5 (50% hit rate after a few requests)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Cache reduces latency by 80%+ for hits"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Semantic search works (similar queries match)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Cache doesn't serve stale data (TTL works)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Cache hit rate >30% after 100 requests"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcb0 Cost Savings"}),": 50% reduction if cache hit rate = 50%"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.20 (60K tokens)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\ud83c\udfaf Step 6.2: Implement Intelligent Model Routing"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,r.jsx)(n.p,{children:"Consult the Data Analyst and Planner agents."}),"\n",(0,r.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,r.jsx)(n.p,{children:"We're using expensive models (Claude, GPT-4o) for all tasks. Many tasks could use cheaper models."}),"\n",(0,r.jsx)(n.p,{children:"TASK:"}),"\n",(0,r.jsx)(n.p,{children:"Data Analyst: Analyze task complexity"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Simple tasks (<100 tokens output): GPT-4o-mini ($0.15/MTok)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Medium tasks (100-500 tokens): GPT-4o ($5/MTok)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Complex tasks (>500 tokens, code generation): Claude ($3/MTok)"}),"\n",(0,r.jsx)(n.p,{children:"Planner: Design routing logic"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Estimate task complexity from prompt (use heuristics or small model)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Select cheapest model that can handle it"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Track model performance (did cheaper model succeed?)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Auto-upgrade if cheap model fails repeatedly"}),"\n",(0,r.jsx)(n.p,{children:"HEURISTICS:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'"simple question", "what is", "explain" \u2192 cheap model'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'"build", "implement", "refactor" \u2192 expensive model'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'"review", "analyze", "compare" \u2192 medium model'}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"IMPLEMENTATION:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Model router: src/lib/model-router.ts"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Complexity estimator (rule-based or ML)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Fallback if cheap model fails"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Metrics: cost_saved_by_routing"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Model routing logic"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Integration in agent invocations"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Performance tracking dashboard"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"A/B test results (routed vs always-expensive)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"Review the routing heuristics:"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Rules make sense (not too aggressive on downgrading)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Has safety net (upgrades if cheap model fails)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Tracks performance (can revert if quality drops)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Doesn't route security tasks to cheap models"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Test routing"}),":"]}),"\n",(0,r.jsx)(n.h1,{id:"simple-query-should-use-cheap-model",children:"Simple query (should use cheap model)"}),"\n",(0,r.jsxs)(n.p,{children:["curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"what is react?"}]}\'']}),"\n",(0,r.jsx)(n.h1,{id:"check-logs-for-model-selected-gpt-4o-mini",children:'Check logs for: "Model selected: gpt-4o-mini"'}),"\n",(0,r.jsx)(n.h1,{id:"complex-query-should-use-expensive-model",children:"Complex query (should use expensive model)"}),"\n",(0,r.jsxs)(n.p,{children:["curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"build a full authentication system with JWT"}]}\'']}),"\n",(0,r.jsx)(n.h1,{id:"check-logs-for-model-selected-claude-3-5-sonnet",children:'Check logs for: "Model selected: claude-3-5-sonnet"'}),"\n",(0,r.jsx)(n.h1,{id:"after-100-requests-check-savings",children:"After 100 requests, check savings"}),"\n",(0,r.jsxs)(n.p,{children:["curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/metrics",children:"http://localhost:3000/metrics"})," | grep cost_saved"]}),"\n",(0,r.jsx)(n.h1,{id:"should-show-significant-savings-30-50",children:"Should show significant savings (30-50%)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Simple tasks use cheap models"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Complex tasks use expensive models"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Quality doesn't drop (test manually or with eval set)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Cost savings 30-50%"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcb0 Cost Savings"}),": Additional 30-40% on top of caching"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.15 (45K tokens)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\ud83d\uddc4\ufe0f Step 6.3: Optimize Database Queries"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,r.jsx)(n.p,{children:"Consult the Data Analyst and Builder agents."}),"\n",(0,r.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,r.jsx)(n.p,{children:"Database queries can be slow, especially as data grows. Optimize now before it becomes a problem."}),"\n",(0,r.jsx)(n.p,{children:"TASK:"}),"\n",(0,r.jsx)(n.p,{children:"Data Analyst: Analyze current queries"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Run EXPLAIN on all queries in src/lib/*.ts"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Identify slow queries (>100ms)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Recommend indexes"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Check for N+1 query problems"}),"\n",(0,r.jsx)(n.p,{children:"Builder: Implement optimizations"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Add missing indexes"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Rewrite slow queries (use JOINs instead of multiple SELECTs)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Add query result caching (for analytics)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Use connection pooling"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Consider read replicas if high read load"}),"\n",(0,r.jsx)(n.p,{children:"FOCUS AREAS:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"token_usage table (heavy writes, frequent aggregations)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"chat_history table (joins with users)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"agent_state table (if exists)"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Database analysis: docs/architecture/db-optimization.md"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Index creation migration"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Query rewrites (before/after benchmarks)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Connection pool configuration"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Performance comparison report"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"Review the proposed indexes:"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Indexes on foreign keys (user_id, session_id)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Indexes on frequently queried columns (timestamp, agent_name)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Not over-indexed (too many indexes slow writes)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Composite indexes for common query patterns"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Run optimization"}),":"]}),"\n",(0,r.jsx)(n.h1,{id:"run-database-migrations",children:"Run database migrations"}),"\n",(0,r.jsxs)(n.p,{children:["npm run db",":migrate"]}),"\n",(0,r.jsx)(n.h1,{id:"run-benchmark-beforeafter",children:"Run benchmark before/after"}),"\n",(0,r.jsxs)(n.p,{children:["npm run benchmark",":db"]}),"\n",(0,r.jsx)(n.h1,{id:"check-query-performance",children:"Check query performance"}),"\n",(0,r.jsx)(n.p,{children:"sqlite3 data/hive.db << 'EOF'"}),"\n",(0,r.jsx)(n.p,{children:"EXPLAIN QUERY PLAN\xa0"}),"\n",(0,r.jsx)(n.p,{children:"SELECT SUM(cost_usd) FROM token_usage\xa0"}),"\n",(0,r.jsx)(n.p,{children:"WHERE timestamp > datetime('now', '-1 day')\xa0"}),"\n",(0,r.jsx)(n.p,{children:"GROUP BY agent_name;"}),"\n",(0,r.jsx)(n.p,{children:"EOF"}),"\n",(0,r.jsx)(n.h1,{id:"should-show-using-index-idx_token_usage_timestamp",children:'Should show "USING INDEX idx_token_usage_timestamp"'}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"\u2610 All slow queries now <50ms"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Indexes used (check EXPLAIN output)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Write performance not degraded"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Connection pool active (check logs)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.10 (30K tokens)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\ud83d\udd25 Step 6.4: Implement Request Rate Limiting"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor):"]}),"\n",(0,r.jsx)(n.p,{children:"Consult the Security and Builder agents."}),"\n",(0,r.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,r.jsx)(n.p,{children:"Users (or attackers) could spam our API, causing cost explosions."}),"\n",(0,r.jsx)(n.p,{children:"TASK:"}),"\n",(0,r.jsx)(n.p,{children:"Implement multi-tier rate limiting:"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Anonymous users: 10 requests/hour"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Authenticated free users: 100 requests/hour"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Authenticated paid users: 1000 requests/hour"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Admin users: No limit"}),"\n",(0,r.jsx)(n.p,{children:"IMPLEMENTATION:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Use @hono/rate-limit or custom Redis-based limiter"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Track by: IP address (anonymous) or user ID (authenticated)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Response: 429 Too Many Requests with retry-after header"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"SPECIAL CASES:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Burst allowance (allow 20 requests in 1 minute, but 100/hour average)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Whitelist certain IPs (monitoring systems)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Different limits for different endpoints (GET /health unlimited)"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Rate limiting middleware: src/middleware/rate-limit.ts"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Configuration in .env (limits per tier)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"User tier detection (from auth token)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Tests for rate limit enforcement"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Documentation for API consumers"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"Review rate limits:"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Limits are reasonable (not too strict for legitimate use)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Different tiers make sense"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Headers inform users of limits"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Has bypass for emergencies (admin override)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Test"}),":"]}),"\n",(0,r.jsx)(n.h1,{id:"test-anonymous-limit-10hour",children:"Test anonymous limit (10/hour)"}),"\n",(0,r.jsx)(n.p,{children:"for i in {1..15}; do"}),"\n",(0,r.jsxs)(n.p,{children:["\xa0 curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"}),' -d \'{"messages":[{"role":"user","content":"test"}]}\'']}),"\n",(0,r.jsx)(n.p,{children:"done"}),"\n",(0,r.jsx)(n.h1,{id:"after-10-requests-should-get-429",children:"After 10 requests, should get 429"}),"\n",(0,r.jsx)(n.h1,{id:"check-headers",children:"Check headers"}),"\n",(0,r.jsxs)(n.p,{children:["curl -I ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"})]}),"\n",(0,r.jsx)(n.h1,{id:"should-see-x-ratelimit-remaining-9",children:"Should see: X-RateLimit-Remaining: 9"}),"\n",(0,r.jsx)(n.h1,{id:"test-with-auth-token-higher-limit",children:"Test with auth token (higher limit)"}),"\n",(0,r.jsx)(n.p,{children:"for i in {1..20}; do"}),"\n",(0,r.jsxs)(n.p,{children:["\xa0 curl ",(0,r.jsx)(n.a,{href:"http://localhost:3000/chat",children:"http://localhost:3000/chat"})," \\"]}),"\n",(0,r.jsx)(n.p,{children:'\xa0 \xa0 -H "Authorization: Bearer $TOKEN" \\'}),"\n",(0,r.jsx)(n.p,{children:'\xa0 \xa0 -d \'{"messages":[{"role":"user","content":"test"}]}\''}),"\n",(0,r.jsx)(n.p,{children:"done"}),"\n",(0,r.jsx)(n.h1,{id:"should-succeed-authenticated--100hour",children:"Should succeed (authenticated = 100/hour)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Rate limiting enforces limits correctly"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Different tiers have different limits"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Headers inform users"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Burst allowance works"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.08 (25K tokens)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\ud83d\udce6 Step 6.5: Optimize Bundle Size (Frontend)"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Your Instruction"})," (in Cursor, open client/package.json):"]}),"\n",(0,r.jsx)(n.p,{children:"Consult the Builder agent."}),"\n",(0,r.jsx)(n.p,{children:"CONTEXT:"}),"\n",(0,r.jsx)(n.p,{children:"Large JavaScript bundles slow page load and hurt user experience."}),"\n",(0,r.jsx)(n.p,{children:"TASK:"}),"\n",(0,r.jsx)(n.p,{children:"Analyze and optimize frontend bundle:"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Run bundle analyzer (webpack-bundle-analyzer or similar)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Identify large dependencies"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Implement code splitting (lazy load routes)"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Tree-shake unused code"}),"\n",(0,r.jsx)(n.p,{children:"\xa0 - Use lighter alternatives for heavy libs"}),"\n",(0,r.jsx)(n.p,{children:"TARGETS:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Initial load: <200KB gzipped"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Time to Interactive: <3s on 4G"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"COMMON OPTIMIZATIONS:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Lazy load dashboard page (only load when navigating)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Use date-fns instead of moment.js (if used)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Dynamic imports for chart libraries"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Remove unused CSS (PurgeCSS)"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Compress images"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"DELIVERABLES:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Bundle analysis report: docs/architecture/bundle-optimization.md"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Optimized webpack/vite config"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Lazy loading for routes"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Before/after Lighthouse scores"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u23f8\ufe0f YOUR APPROVAL GATE"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"Review bundle analysis:"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Identifies biggest contributors (chart lib, etc)"}),"\n",(0,r.jsx)(n.p,{children:'\u2610 Proposes reasonable alternatives (not "rewrite everything")'}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Code splitting doesn't break functionality"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Images optimized (WebP, compressed)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Run optimization"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"cd client"}),"\n",(0,r.jsx)(n.h1,{id:"analyze-bundle",children:"Analyze bundle"}),"\n",(0,r.jsx)(n.p,{children:"npm run build"}),"\n",(0,r.jsx)(n.p,{children:"npm run analyze\xa0 # If configured, or:"}),"\n",(0,r.jsx)(n.p,{children:"npx vite-bundle-visualizer"}),"\n",(0,r.jsx)(n.h1,{id:"check-bundle-size",children:"Check bundle size"}),"\n",(0,r.jsx)(n.p,{children:"ls -lh dist/assets/*.js"}),"\n",(0,r.jsx)(n.h1,{id:"should-be-200kb-for-main-bundle",children:"Should be <200KB for main bundle"}),"\n",(0,r.jsx)(n.h1,{id:"run-lighthouse",children:"Run Lighthouse"}),"\n",(0,r.jsxs)(n.p,{children:["npx lighthouse ",(0,r.jsx)(n.a,{href:"http://localhost:5173",children:"http://localhost:5173"})," --output=json"]}),"\n",(0,r.jsx)(n.h1,{id:"compare-beforeafter-performance-score",children:"Compare before/after Performance score"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u2705 Validation"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Bundle size reduced by 30%+"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Lighthouse Performance score >90"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Time to Interactive <3s"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 All features still work"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udcca Log Cost"}),": ~$0.10 (30K tokens)"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u2705 Phase 6 Complete When:"})}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Response caching implemented (50%+ hit rate)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Model routing saving 30-40% costs"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Database queries optimized (<50ms)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Rate limiting active"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Frontend bundle optimized (<200KB)"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Overall cost reduced by 60-70%"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Latency reduced by 80% for cached requests"}),"\n",(0,r.jsx)(n.p,{children:"\u2610 Total cost <$30 for Phase 6"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83d\udca1 Key Insight"}),": Performance = Cost Savings. Fast systems are cheap systems."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\ud83c\udf89 MAJOR MILESTONE"}),": Your system now runs 60-70% cheaper with better performance."]}),"\n",(0,r.jsx)(n.p,{children:"**"})]})}function a(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>c});var i=s(6540);const r={},l=i.createContext(r);function t(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);